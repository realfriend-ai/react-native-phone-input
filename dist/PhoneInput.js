"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const react_1 = __importDefault(require("react"));
const react_native_1 = require("react-native");
const country_1 = __importDefault(require("./country"));
const flags_1 = __importDefault(require("./resources/flags"));
const phoneNumber_1 = __importDefault(require("./phoneNumber"));
const styles_1 = __importDefault(require("./styles"));
const CountryPicker_1 = __importDefault(require("./CountryPicker"));
class PhoneInput extends react_1.default.Component {
    constructor(props) {
        super(props);
        this.onChangePhoneNumber = (number) => {
            const actionAfterSetState = this.props.onChangePhoneNumber
                ? (displayValue, iso2) => {
                    var _a, _b;
                    (_b = (_a = this.props).onChangePhoneNumber) === null || _b === void 0 ? void 0 : _b.call(_a, displayValue, iso2);
                }
                : null;
            this.updateValue(number, actionAfterSetState);
        };
        this.onPressFlag = () => {
            if (this.props.onPressFlag) {
                this.props.onPressFlag();
            }
            else {
                if (this.state.iso2)
                    this.picker.selectCountry(this.state.iso2);
                this.picker.show();
            }
        };
        // eslint-disable-next-line class-methods-use-this
        this.getFlag = (iso2) => flags_1.default.get(iso2);
        this.getISOCode = () => this.state.iso2;
        this.selectCountry = (iso2) => {
            if (this.state.iso2 !== iso2) {
                const countryData = phoneNumber_1.default.getCountryDataByCode(iso2);
                if (countryData) {
                    this.setState({
                        iso2,
                        displayValue: this.format(''),
                        value: ''
                    }, () => {
                        if (this.props.onSelectCountry)
                            this.props.onSelectCountry(iso2);
                    });
                }
            }
        };
        this.setValue = (number) => {
            if (this.state.value !== number) {
                this.updateValue(number);
            }
        };
        const initialValue = '';
        let { initialCountry } = this.props;
        const { countriesList, disabled, } = this.props;
        if (countriesList) {
            country_1.default.setCustomCountriesData(countriesList);
        }
        let displayValue = '';
        if (initialValue) {
            initialCountry = phoneNumber_1.default.getCountryCodeOfNumber(initialValue);
            displayValue = this.format(initialValue, initialCountry);
        }
        this.state = {
            disabled,
            iso2: initialCountry,
            displayValue,
            value: initialValue,
        };
    }
    static setCustomCountriesData(json) {
        country_1.default.setCustomCountriesData(json);
    }
    componentDidUpdate() {
        const { disabled } = this.props;
        if (disabled !== this.state.disabled) {
            this.setState({ disabled }); // eslint-disable-line react/no-did-update-set-state
        }
    }
    // eslint-disable-next-line class-methods-use-this
    getPickerData() {
        return phoneNumber_1.default.getAllCountries().map((country, index) => ({
            key: index,
            image: flags_1.default.get(country.iso2),
            label: country.name,
            dialCode: `+${country.dialCode}`,
            iso2: country.iso2
        }));
    }
    getCountryCode() {
        const countryData = phoneNumber_1.default.getCountryDataByCode(this.state.iso2);
        return countryData ? countryData.dialCode : null;
    }
    // eslint-disable-next-line class-methods-use-this
    getAllCountries() {
        return phoneNumber_1.default.getAllCountries();
    }
    getDialCode() {
        return phoneNumber_1.default.getDialCode(this.state.value);
    }
    getValue(text) {
        return text ? text.replace(/[^0-9]/g, '') : this.state.value;
    }
    getNumberType() {
        return phoneNumber_1.default.getNumberType(this.state.value, this.state.iso2);
    }
    isValidNumber() {
        if (this.state.value.length < 4)
            return false;
        return phoneNumber_1.default.isValidNumber(this.state.value, this.state.iso2);
    }
    format(text, iso2) {
        return this.props.autoFormat
            ? phoneNumber_1.default.format(text, iso2 || this.state.iso2)
            : text;
    }
    updateValue(number, actionAfterSetState = null) {
        let modifiedNumber = this.getValue(number);
        const { allowZeroAfterCountryCode } = this.props;
        modifiedNumber = allowZeroAfterCountryCode
            ? modifiedNumber
            : this.possiblyEliminateZeroAfterCountryCode(modifiedNumber);
        const iso2 = phoneNumber_1.default.getCountryCodeOfNumber(modifiedNumber) || this.state.iso2;
        const displayValue = modifiedNumber;
        this.setState({
            iso2,
            displayValue,
            value: modifiedNumber,
        }, () => {
            if (actionAfterSetState) {
                actionAfterSetState(displayValue, iso2);
            }
        });
    }
    // eslint-disable-next-line class-methods-use-this
    possiblyEliminateZeroAfterCountryCode(number) {
        const dialCode = phoneNumber_1.default.getDialCode(number);
        return number.startsWith(`${dialCode}0`)
            ? dialCode + number.substr(dialCode.length + 1)
            : number;
    }
    focus() {
        this.inputPhone.focus();
    }
    blur() {
        this.inputPhone.blur();
    }
    render() {
        const { iso2, displayValue, disabled } = this.state;
        const TextComponent = this.props.textComponent || react_native_1.TextInput;
        return (react_1.default.createElement(react_native_1.View, { style: [styles_1.default.container, this.props.style] },
            react_1.default.createElement(react_native_1.TouchableWithoutFeedback, { onPress: this.onPressFlag, disabled: disabled },
                react_1.default.createElement(react_native_1.Image, { source: flags_1.default.get(iso2), style: [styles_1.default.flag, this.props.flagStyle] })),
            react_1.default.createElement(react_native_1.View, { style: { flex: 1, marginLeft: this.props.offset || 10 } },
                react_1.default.createElement(TextComponent, Object.assign({ ref: (ref) => {
                        this.inputPhone = ref;
                    }, editable: !disabled, autoCorrect: false, style: [styles_1.default.text, this.props.textStyle], onChangeText: (text) => {
                        this.onChangePhoneNumber(text);
                    }, keyboardType: "phone-pad", underlineColorAndroid: "rgba(0,0,0,0)", value: displayValue }, this.props.textProps))),
            react_1.default.createElement(CountryPicker_1.default, { ref: (ref) => {
                    this.picker = ref;
                }, selectedCountry: iso2, onSubmit: this.selectCountry, buttonColor: this.props.pickerButtonColor, cancelText: this.props.cancelText, cancelTextStyle: this.props.cancelTextStyle, confirmText: this.props.confirmText, confirmTextStyle: this.props.confirmTextStyle, pickerBackgroundColor: this.props.pickerBackgroundColor, itemStyle: this.props.pickerItemStyle, onPressCancel: this.props.onPressCancel, onPressConfirm: this.props.onPressConfirm })));
    }
}
exports.default = PhoneInput;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGhvbmVJbnB1dC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9QaG9uZUlucHV0LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLGtEQUEwQjtBQUMxQiwrQ0FFc0I7QUFDdEIsd0RBQWdDO0FBQ2hDLDhEQUFzQztBQUN0QyxnRUFBd0M7QUFDeEMsc0RBQThCO0FBQzlCLG9FQUE0QztBQUc1QyxNQUFxQixVQUNqQixTQUFRLGVBQUssQ0FBQyxTQUE2RDtJQVMzRSxZQUFZLEtBQUs7UUFDYixLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFxQ2pCLHdCQUFtQixHQUFHLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDN0IsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLG1CQUFtQjtnQkFDdEQsQ0FBQyxDQUFDLENBQUMsWUFBb0IsRUFBRSxJQUFZLEVBQUUsRUFBRTs7b0JBQ2pDLE1BQUEsTUFBQSxJQUFJLENBQUMsS0FBSyxFQUFDLG1CQUFtQixtREFBRyxZQUFZLEVBQUUsSUFBSSxFQUFFO2dCQUM3RCxDQUFDO2dCQUNELENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDWCxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO1FBQ2xELENBQUMsQ0FBQTtRQUVELGdCQUFXLEdBQUcsR0FBRyxFQUFFO1lBQ2YsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRTtnQkFDeEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQzthQUM1QjtpQkFBTTtnQkFDSCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSTtvQkFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNoRSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO2FBQ3RCO1FBQ0wsQ0FBQyxDQUFBO1FBdUJE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QyxTQUFTLENBQUMsRUFDMUMsWUFBWSxFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUU7d0JBQ25CLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDbkMsQ0FBQyxFQUNELFlBQVksRUFBQyxXQUFXLEVBQ3hCLHFCQUFxQixFQUFDLGVBQWUsRUFDckMsS0FBSyxFQUFFLFlBQVksSUFDZixJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFDMUIsQ0FDQztZQUVQLDhCQUFDLHVCQUFhLElBQ1YsR0FBRyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUU7b0JBQ1QsSUFBSSxDQUFDLE1BQU0sR0FBRyxHQUFHLENBQUM7Z0JBQ3RCLENBQUMsRUFDRCxlQUFlLEVBQUUsSUFBSSxFQUNyQixRQUFRLEVBQUUsSUFBSSxDQUFDLGFBQWEsRUFDNUIsV0FBVyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsaUJBQWlCLEVBQ3pDLFVBQVUsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFDakMsZUFBZSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsZUFBZSxFQUMzQyxXQUFXLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQ25DLGdCQUFnQixFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLEVBQzdDLHFCQUFxQixFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMscUJBQXFCLEVBQ3ZELFNBQVMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLGVBQWUsRUFDckMsYUFBYSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxFQUN2QyxjQUFjLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFjLEdBQzNDLENBQ0MsQ0FDVixDQUFDO0lBQ04sQ0FBQztDQUNKO0FBeE9ELDZCQXdPQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQge1xuICAgIEltYWdlLCBUZXh0SW5wdXQsIFRvdWNoYWJsZVdpdGhvdXRGZWVkYmFjaywgVmlld1xufSBmcm9tICdyZWFjdC1uYXRpdmUnO1xuaW1wb3J0IENvdW50cnkgZnJvbSAnLi9jb3VudHJ5JztcbmltcG9ydCBGbGFncyBmcm9tICcuL3Jlc291cmNlcy9mbGFncyc7XG5pbXBvcnQgUGhvbmVOdW1iZXIgZnJvbSAnLi9waG9uZU51bWJlcic7XG5pbXBvcnQgc3R5bGVzIGZyb20gJy4vc3R5bGVzJztcbmltcG9ydCBDb3VudHJ5UGlja2VyIGZyb20gJy4vQ291bnRyeVBpY2tlcic7XG5pbXBvcnQgeyBSZWFjdE5hdGl2ZVBob25lSW5wdXRQcm9wcyB9IGZyb20gJy4vdHlwaW5ncyc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFBob25lSW5wdXQ8VGV4dENvbXBvbmVudFR5cGUgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnRUeXBlID0gdHlwZW9mIFRleHRJbnB1dD5cbiAgICBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxSZWFjdE5hdGl2ZVBob25lSW5wdXRQcm9wczxUZXh0Q29tcG9uZW50VHlwZT4sIGFueT4ge1xuICAgIHN0YXRpYyBzZXRDdXN0b21Db3VudHJpZXNEYXRhKGpzb24pIHtcbiAgICAgICAgQ291bnRyeS5zZXRDdXN0b21Db3VudHJpZXNEYXRhKGpzb24pO1xuICAgIH1cblxuICAgIHByaXZhdGUgcGlja2VyOiBhbnk7XG5cbiAgICBwcml2YXRlIGlucHV0UGhvbmU6IGFueTtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcblxuICAgICAgICBjb25zdCBpbml0aWFsVmFsdWUgPSAnJztcbiAgICAgICAgbGV0IHtcbiAgICAgICAgICAgIGluaXRpYWxDb3VudHJ5XG4gICAgICAgIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgICAgIGNvbnN0IHtcbiAgICAgICAgICAgIGNvdW50cmllc0xpc3QsIGRpc2FibGVkLFxuICAgICAgICB9ID0gdGhpcy5wcm9wcztcblxuICAgICAgICBpZiAoY291bnRyaWVzTGlzdCkge1xuICAgICAgICAgICAgQ291bnRyeS5zZXRDdXN0b21Db3VudHJpZXNEYXRhKGNvdW50cmllc0xpc3QpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGRpc3BsYXlWYWx1ZSA9ICcnO1xuXG4gICAgICAgIGlmIChpbml0aWFsVmFsdWUpIHtcbiAgICAgICAgICAgIGluaXRpYWxDb3VudHJ5ID0gUGhvbmVOdW1iZXIuZ2V0Q291bnRyeUNvZGVPZk51bWJlcihpbml0aWFsVmFsdWUpO1xuICAgICAgICAgICAgZGlzcGxheVZhbHVlID0gdGhpcy5mb3JtYXQoaW5pdGlhbFZhbHVlLCBpbml0aWFsQ291bnRyeSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgZGlzYWJsZWQsXG4gICAgICAgICAgICBpc28yOiBpbml0aWFsQ291bnRyeSxcbiAgICAgICAgICAgIGRpc3BsYXlWYWx1ZSxcbiAgICAgICAgICAgIHZhbHVlOiBpbml0aWFsVmFsdWUsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgY29tcG9uZW50RGlkVXBkYXRlKCkge1xuICAgICAgICBjb25zdCB7IGRpc2FibGVkIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBpZiAoZGlzYWJsZWQgIT09IHRoaXMuc3RhdGUuZGlzYWJsZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBkaXNhYmxlZCB9KTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZWFjdC9uby1kaWQtdXBkYXRlLXNldC1zdGF0ZVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgb25DaGFuZ2VQaG9uZU51bWJlciA9IChudW1iZXIpID0+IHtcbiAgICAgICAgY29uc3QgYWN0aW9uQWZ0ZXJTZXRTdGF0ZSA9IHRoaXMucHJvcHMub25DaGFuZ2VQaG9uZU51bWJlclxuICAgICAgICAgICAgPyAoZGlzcGxheVZhbHVlOiBzdHJpbmcsIGlzbzI6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnByb3BzLm9uQ2hhbmdlUGhvbmVOdW1iZXI/LihkaXNwbGF5VmFsdWUsIGlzbzIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgOiBudWxsO1xuICAgICAgICB0aGlzLnVwZGF0ZVZhbHVlKG51bWJlciwgYWN0aW9uQWZ0ZXJTZXRTdGF0ZSk7XG4gICAgfVxuXG4gICAgb25QcmVzc0ZsYWcgPSAoKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLnByb3BzLm9uUHJlc3NGbGFnKSB7XG4gICAgICAgICAgICB0aGlzLnByb3BzLm9uUHJlc3NGbGFnKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAodGhpcy5zdGF0ZS5pc28yKSB0aGlzLnBpY2tlci5zZWxlY3RDb3VudHJ5KHRoaXMuc3RhdGUuaXNvMik7XG4gICAgICAgICAgICB0aGlzLnBpY2tlci5zaG93KCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY2xhc3MtbWV0aG9kcy11c2UtdGhpc1xuICAgIGdldFBpY2tlckRhdGEoKSB7XG4gICAgICAgIHJldHVybiBQaG9uZU51bWJlci5nZXRBbGxDb3VudHJpZXMoKS5tYXAoKGNvdW50cnksIGluZGV4KSA9PiAoe1xuICAgICAgICAgICAga2V5OiBpbmRleCxcbiAgICAgICAgICAgIGltYWdlOiBGbGFncy5nZXQoY291bnRyeS5pc28yKSxcbiAgICAgICAgICAgIGxhYmVsOiBjb3VudHJ5Lm5hbWUsXG4gICAgICAgICAgICBkaWFsQ29kZTogYCske2NvdW50cnkuZGlhbENvZGV9YCxcbiAgICAgICAgICAgIGlzbzI6IGNvdW50cnkuaXNvMlxuICAgICAgICB9KSk7XG4gICAgfVxuXG4gICAgZ2V0Q291bnRyeUNvZGUoKSB7XG4gICAgICAgIGNvbnN0IGNvdW50cnlEYXRhID0gUGhvbmVOdW1iZXIuZ2V0Q291bnRyeURhdGFCeUNvZGUodGhpcy5zdGF0ZS5pc28yKTtcbiAgICAgICAgcmV0dXJuIGNvdW50cnlEYXRhID8gY291bnRyeURhdGEuZGlhbENvZGUgOiBudWxsO1xuICAgIH1cblxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjbGFzcy1tZXRob2RzLXVzZS10aGlzXG4gICAgZ2V0QWxsQ291bnRyaWVzKCkge1xuICAgICAgICByZXR1cm4gUGhvbmVOdW1iZXIuZ2V0QWxsQ291bnRyaWVzKCk7XG4gICAgfVxuXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNsYXNzLW1ldGhvZHMtdXNlLXRoaXNcbiAgICBnZXRGbGFnID0gKGlzbzIpID0+IEZsYWdzLmdldChpc28yKTtcblxuICAgIGdldERpYWxDb2RlKCkge1xuICAgICAgICByZXR1cm4gUGhvbmVOdW1iZXIuZ2V0RGlhbENvZGUodGhpcy5zdGF0ZS52YWx1ZSk7XG4gICAgfVxuXG4gICAgZ2V0VmFsdWUodGV4dD8pIHtcbiAgICAgICAgcmV0dXJuIHRleHQgPyB0ZXh0LnJlcGxhY2UoL1teMC05XS9nLCAnJykgOiB0aGlzLnN0YXRlLnZhbHVlO1xuICAgIH1cblxuICAgIGdldE51bWJlclR5cGUoKSB7XG4gICAgICAgIHJldHVybiBQaG9uZU51bWJlci5nZXROdW1iZXJUeXBlKFxuICAgICAgICAgICAgdGhpcy5zdGF0ZS52YWx1ZSxcbiAgICAgICAgICAgIHRoaXMuc3RhdGUuaXNvMlxuICAgICAgICApO1xuICAgIH1cblxuICAgIGdldElTT0NvZGUgPSAoKSA9PiB0aGlzLnN0YXRlLmlzbzI7XG5cbiAgICBzZWxlY3RDb3VudHJ5ID0gKGlzbzIpID0+IHtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuaXNvMiAhPT0gaXNvMikge1xuICAgICAgICAgICAgY29uc3QgY291bnRyeURhdGEgPSBQaG9uZU51bWJlci5nZXRDb3VudHJ5RGF0YUJ5Q29kZShpc28yKTtcbiAgICAgICAgICAgIGlmIChjb3VudHJ5RGF0YSkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzbzIsXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5VmFsdWU6IHRoaXMuZm9ybWF0KCcnKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiAnJ1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wcm9wcy5vblNlbGVjdENvdW50cnkpIHRoaXMucHJvcHMub25TZWxlY3RDb3VudHJ5KGlzbzIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHNldFZhbHVlID0gKG51bWJlcikgPT4ge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS52YWx1ZSAhPT0gbnVtYmVyKSB7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVZhbHVlKG51bWJlcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpc1ZhbGlkTnVtYmVyKCkge1xuICAgICAgICBpZiAodGhpcy5zdGF0ZS52YWx1ZS5sZW5ndGggPCA0KSByZXR1cm4gZmFsc2U7XG4gICAgICAgIHJldHVybiBQaG9uZU51bWJlci5pc1ZhbGlkTnVtYmVyKFxuICAgICAgICAgICAgdGhpcy5zdGF0ZS52YWx1ZSxcbiAgICAgICAgICAgIHRoaXMuc3RhdGUuaXNvMlxuICAgICAgICApO1xuICAgIH1cblxuICAgIGZvcm1hdCh0ZXh0LCBpc28yPykge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy5hdXRvRm9ybWF0XG4gICAgICAgICAgICA/IFBob25lTnVtYmVyLmZvcm1hdCh0ZXh0LCBpc28yIHx8IHRoaXMuc3RhdGUuaXNvMilcbiAgICAgICAgICAgIDogdGV4dDtcbiAgICB9XG5cbiAgICB1cGRhdGVWYWx1ZShudW1iZXIsIGFjdGlvbkFmdGVyU2V0U3RhdGU6IGFueSA9IG51bGwpIHtcbiAgICAgICAgbGV0IG1vZGlmaWVkTnVtYmVyID0gdGhpcy5nZXRWYWx1ZShudW1iZXIpO1xuICAgICAgICBjb25zdCB7IGFsbG93WmVyb0FmdGVyQ291bnRyeUNvZGUgfSA9IHRoaXMucHJvcHM7XG5cbiAgICAgICAgbW9kaWZpZWROdW1iZXIgPSBhbGxvd1plcm9BZnRlckNvdW50cnlDb2RlXG4gICAgICAgICAgICA/IG1vZGlmaWVkTnVtYmVyXG4gICAgICAgICAgICA6IHRoaXMucG9zc2libHlFbGltaW5hdGVaZXJvQWZ0ZXJDb3VudHJ5Q29kZShtb2RpZmllZE51bWJlcik7XG4gICAgICAgIGNvbnN0IGlzbzI6IHN0cmluZyA9IFBob25lTnVtYmVyLmdldENvdW50cnlDb2RlT2ZOdW1iZXIobW9kaWZpZWROdW1iZXIpIHx8IHRoaXMuc3RhdGUuaXNvMjtcbiAgICAgICAgY29uc3QgZGlzcGxheVZhbHVlID0gbW9kaWZpZWROdW1iZXI7XG4gICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgaXNvMixcbiAgICAgICAgICAgIGRpc3BsYXlWYWx1ZSxcbiAgICAgICAgICAgIHZhbHVlOiBtb2RpZmllZE51bWJlcixcbiAgICAgICAgfSwgKCkgPT4ge1xuICAgICAgICAgICAgaWYgKGFjdGlvbkFmdGVyU2V0U3RhdGUpIHtcbiAgICAgICAgICAgICAgICBhY3Rpb25BZnRlclNldFN0YXRlKGRpc3BsYXlWYWx1ZSwgaXNvMik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjbGFzcy1tZXRob2RzLXVzZS10aGlzXG4gICAgcG9zc2libHlFbGltaW5hdGVaZXJvQWZ0ZXJDb3VudHJ5Q29kZShudW1iZXIpIHtcbiAgICAgICAgY29uc3QgZGlhbENvZGUgPSBQaG9uZU51bWJlci5nZXREaWFsQ29kZShudW1iZXIpO1xuICAgICAgICByZXR1cm4gbnVtYmVyLnN0YXJ0c1dpdGgoYCR7ZGlhbENvZGV9MGApXG4gICAgICAgICAgICA/IGRpYWxDb2RlICsgbnVtYmVyLnN1YnN0cihkaWFsQ29kZS5sZW5ndGggKyAxKVxuICAgICAgICAgICAgOiBudW1iZXI7XG4gICAgfVxuXG4gICAgZm9jdXMoKSB7XG4gICAgICAgIHRoaXMuaW5wdXRQaG9uZS5mb2N1cygpO1xuICAgIH1cblxuICAgIGJsdXIoKSB7XG4gICAgICAgIHRoaXMuaW5wdXRQaG9uZS5ibHVyKCk7XG4gICAgfVxuXG4gICAgcmVuZGVyKCkge1xuICAgICAgICBjb25zdCB7IGlzbzIsIGRpc3BsYXlWYWx1ZSwgZGlzYWJsZWQgfSA9IHRoaXMuc3RhdGU7XG4gICAgICAgIGNvbnN0IFRleHRDb21wb25lbnQ6IGFueSA9IHRoaXMucHJvcHMudGV4dENvbXBvbmVudCB8fCBUZXh0SW5wdXQ7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8VmlldyBzdHlsZT17W3N0eWxlcy5jb250YWluZXIsIHRoaXMucHJvcHMuc3R5bGVdfT5cbiAgICAgICAgICAgICAgICA8VG91Y2hhYmxlV2l0aG91dEZlZWRiYWNrXG4gICAgICAgICAgICAgICAgICAgIG9uUHJlc3M9e3RoaXMub25QcmVzc0ZsYWd9XG4gICAgICAgICAgICAgICAgICAgIGRpc2FibGVkPXtkaXNhYmxlZH1cbiAgICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgICAgIDxJbWFnZVxuICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlPXtGbGFncy5nZXQoaXNvMil9XG4gICAgICAgICAgICAgICAgICAgICAgICBzdHlsZT17W3N0eWxlcy5mbGFnLCB0aGlzLnByb3BzLmZsYWdTdHlsZV19XG4gICAgICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgPC9Ub3VjaGFibGVXaXRob3V0RmVlZGJhY2s+XG4gICAgICAgICAgICAgICAgPFZpZXcgc3R5bGU9e3sgZmxleDogMSwgbWFyZ2luTGVmdDogdGhpcy5wcm9wcy5vZmZzZXQgfHwgMTAgfX0+XG4gICAgICAgICAgICAgICAgICAgIDxUZXh0Q29tcG9uZW50XG4gICAgICAgICAgICAgICAgICAgICAgICByZWY9eyhyZWYpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlucHV0UGhvbmUgPSByZWY7XG4gICAgICAgICAgICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgICAgICAgICAgICAgZWRpdGFibGU9eyFkaXNhYmxlZH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9Db3JyZWN0PXtmYWxzZX1cbiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlPXtbc3R5bGVzLnRleHQsIHRoaXMucHJvcHMudGV4dFN0eWxlXX1cbiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlVGV4dD17KHRleHQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uQ2hhbmdlUGhvbmVOdW1iZXIodGV4dCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgICAgICAgICAgICAga2V5Ym9hcmRUeXBlPVwicGhvbmUtcGFkXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVuZGVybGluZUNvbG9yQW5kcm9pZD1cInJnYmEoMCwwLDAsMClcIlxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU9e2Rpc3BsYXlWYWx1ZX1cbiAgICAgICAgICAgICAgICAgICAgICAgIHsuLi50aGlzLnByb3BzLnRleHRQcm9wc31cbiAgICAgICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICA8L1ZpZXc+XG5cbiAgICAgICAgICAgICAgICA8Q291bnRyeVBpY2tlclxuICAgICAgICAgICAgICAgICAgICByZWY9eyhyZWYpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGlja2VyID0gcmVmO1xuICAgICAgICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZENvdW50cnk9e2lzbzJ9XG4gICAgICAgICAgICAgICAgICAgIG9uU3VibWl0PXt0aGlzLnNlbGVjdENvdW50cnl9XG4gICAgICAgICAgICAgICAgICAgIGJ1dHRvbkNvbG9yPXt0aGlzLnByb3BzLnBpY2tlckJ1dHRvbkNvbG9yfVxuICAgICAgICAgICAgICAgICAgICBjYW5jZWxUZXh0PXt0aGlzLnByb3BzLmNhbmNlbFRleHR9XG4gICAgICAgICAgICAgICAgICAgIGNhbmNlbFRleHRTdHlsZT17dGhpcy5wcm9wcy5jYW5jZWxUZXh0U3R5bGV9XG4gICAgICAgICAgICAgICAgICAgIGNvbmZpcm1UZXh0PXt0aGlzLnByb3BzLmNvbmZpcm1UZXh0fVxuICAgICAgICAgICAgICAgICAgICBjb25maXJtVGV4dFN0eWxlPXt0aGlzLnByb3BzLmNvbmZpcm1UZXh0U3R5bGV9XG4gICAgICAgICAgICAgICAgICAgIHBpY2tlckJhY2tncm91bmRDb2xvcj17dGhpcy5wcm9wcy5waWNrZXJCYWNrZ3JvdW5kQ29sb3J9XG4gICAgICAgICAgICAgICAgICAgIGl0ZW1TdHlsZT17dGhpcy5wcm9wcy5waWNrZXJJdGVtU3R5bGV9XG4gICAgICAgICAgICAgICAgICAgIG9uUHJlc3NDYW5jZWw9e3RoaXMucHJvcHMub25QcmVzc0NhbmNlbH1cbiAgICAgICAgICAgICAgICAgICAgb25QcmVzc0NvbmZpcm09e3RoaXMucHJvcHMub25QcmVzc0NvbmZpcm19XG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgIDwvVmlldz5cbiAgICAgICAgKTtcbiAgICB9XG59XG4iXX0=